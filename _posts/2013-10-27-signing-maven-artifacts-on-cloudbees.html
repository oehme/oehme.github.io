---
layout: post
title: Signing Maven artifacts on Cloudbees
date: '2013-10-27T16:32:00.000+01:00'
author: Stefan Oehme
tags: 
modified_time: '2013-10-27T16:32:10.073+01:00'
thumbnail: http://3.bp.blogspot.com/-pQZ9hJt6sLU/Um0w0bBbxXI/AAAAAAAAKiE/sAk3QfvmB84/s72-c/cyberduck.png
blogger_id: tag:blogger.com,1999:blog-7973028861743150658.post-8553194524146808719
blogger_orig_url: http://mnmlst-dvlpr.blogspot.com/2013/10/signing-maven-artifacts-on-cloudbees.html
---

Recently I set up the build infrastructure for our <a href="http://avacodo.org/">avacodo </a>library. With <a href="https://github.com/">Github</a>, <a href="http://www.cloudbees.com/">Cloudbees </a>and <a href="https://docs.sonatype.org/display/Repository/Sonatype+OSS+Maven+Repository+Usage+Guide">Maven Central</a> it has become surprisingly easy to get your code from your fingertips into everybody's hands quickly and reliably. There is however one obstacle that can be a bit tricky to get right: Signing artifacts on your Cloudbees hosted Jenkins server.<br /><br />Maven Central requires all uploaded artifacts to be signed. Of course, you want to do this with a <a href="https://wiki.jenkins-ci.org/display/JENKINS/M2+Release+Plugin">click of a button on your Jenkins</a> server. I'm assuming that your pom.xml inherits from Sonatype's oss-parent, which has all the necessary configuration for doing releases to the Central repository. I will also assume that you are familiar with how to <a href="https://docs.sonatype.org/display/Repository/How+To+Generate+PGP+Signatures+With+Maven">create gpg keys</a> and that you have published your public key to sks.keyserver.net. So you should be able to do a Maven release on your development machine and a "mvn clean install" on your Jenkins.<br /><br />First, you need to export your public and private key pair. The resulting files should be named pubring.gpg and secring.gpg.<br /><blockquote class="tr_bq">gpg --export key-id &gt; pubring.gpg</blockquote><blockquote class="tr_bq">gpg --export-secret-key key-id &gt; secring.gpg</blockquote>Upload these into your private repository at Cloudbees. Just follow the tutorial on<a href="http://wiki.cloudbees.com/bin/view/DEV/Sharing+Files+with+Build+Executors"> how to share files with build agents</a>. I will use a subdirectory named "gpg" for this. You also need a trustdb.gpg and random_seed file, which - as far as I can tell - can just be empty. They are not needed for signing, but gpg will look for them anyway. You also need a file named gpg.conf with the following line:<br /><blockquote class="tr_bq"><span style="background-color: white;">lock-never</span></blockquote>This tells gpg to never try to lock the key database. This is important because your private repository is mounted read-only during the build.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-pQZ9hJt6sLU/Um0w0bBbxXI/AAAAAAAAKiE/sAk3QfvmB84/s1600/cyberduck.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="213" src="http://3.bp.blogspot.com/-pQZ9hJt6sLU/Um0w0bBbxXI/AAAAAAAAKiE/sAk3QfvmB84/s320/cyberduck.png" width="320" /></a></div><br />Finally, you need to upload a Maven settings.xml with the following configuration:<br /><br /><script src="https://gist.github.com/oehme/7183271.js"></script>Of course you can add as much additional configuration to this settings.xml as you want. The gpg.home points to where you just uploaded your keys. Make sure you have mounted your private repository in your build configuration, as described <a href="http://wiki.cloudbees.com/bin/view/DEV/Sharing+Files+with+Build+Executors">in the tutoria</a>l. The passphrase must be given in plain text. This is another reason to use a separate key for signing and not your personal key! So in case someone breaks into your Cloudbees account, they will not get your whole identity.<br /><br />Now you should be able to do releases to Central on your Jenkins. If you followed all the steps and gpg still tells you that it "cannot obtain passphrase in batch mode", then you might have stumbled over an encoding problem. I have had problems with gpg passphrases that contain German umlauts (Ä,Ö,Ü). So try a simple passphrase first, just to be sure.